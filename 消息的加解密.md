微信公众平台对推送给服务器的消息提供了加密机制，开发人员可以选择是是否启用。

``weixin-java-tools``在``1.0.1``版本中添加了这一支持。

需要注意的是，根据微信官方文档，如果微信传过来的是加密信息，那么返回给微信的也得是加密信息。

```java
String signature = request.getParameter("signature");
String nonce = request.getParameter("nonce");
String timestamp = request.getParameter("timestamp");

String encryptType = StringUtils.isBlank(request.getParameter("encrypt_type")) ?
        "raw" :
        request.getParameter("encrypt_type");

WxXmlMessage inMessage = null;

if ("raw".equals(encryptType)) {
  // 明文传输的消息
  inMessage = WxXmlMessage.fromXml(request.getInputStream());
} else if ("aes".equals(encryptType)) {
  // 是aes加密的消息
  String msgSignature = request.getParameter("msg_signature");
  inMessage = WxXmlMessage.fromEncryptedXml(
      request.getInputStream(),
      wxConfigStorage,
      timestamp, nonce, msgSignature);
} else {
  response.getWriter().println("不可识别的加密类型");
  return;
}

WxXmlOutMessage outMessage = wxMessageRouter.route(inMessage);

if (outMessage != null) {
  if ("raw".equals(encryptType)) {
    response.getWriter().write(outMessage.toXml());
  } else if ("aes".equals(encryptType)) {
    response.getWriter().write(outMessage.toEncryptedXml(wxConfigStorage));
  }
  return;
}
```

## 加解密构成中的异常

如果在加解密的过程中出现``java.security.InvalidKeyException: Illegal key size``，则需要下载一个东西：

JRE/JDK 6：http://www.oracle.com/technetwork/java/javase/downloads/jce-6-download-429243.html

JRE/JDK 7：http://www.oracle.com/technetwork/java/javase/downloads/jce-7-download-432124.html

JRE/JDK 8：http://www.oracle.com/technetwork/java/javase/downloads/jce8-download-2133166.html

如果安装了JRE，将两个jar文件放到``$JAVA_HOME/lib/security``目录下覆盖原来的文件

如果安装了JDK，将两个jar文件放到``$JAVA_HOME/jre/lib/security``目录下覆盖原来文件